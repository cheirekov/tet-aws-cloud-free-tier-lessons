# Използване на DynamoDB за NoSQL бази данни

---

## Какво ще научим днес?

- Какво е Amazon DynamoDB и как работи
- Създаване и конфигуриране на DynamoDB таблици
- Основни операции в DynamoDB (CRUD)
- Използване на индекси за оптимизация на заявки
- Практически проект с DynamoDB и други AWS услуги

---

## Какво е Amazon DynamoDB?

![DynamoDB](https://i.imgur.com/1XZtVnL.png)

Amazon DynamoDB е напълно управлявана NoSQL база данни, която поддържа ключ-стойност и документи модели на данни

---

## Основни концепции на DynamoDB

- **Таблици** - контейнери за данни
- **Елементи** - записи в таблицата
- **Атрибути** - полета в елементите
- **Ключове** - уникални идентификатори за елементите
- **Първичен ключ** - уникален идентификатор за всеки елемент
- **Индекси** - структури за оптимизация на заявки

---

## Как работи DynamoDB?

1. Създавате таблица
2. Добавяте елементи
3. Извършвате заявки
4. Актуализирате елементи
5. Изтривате елементи
6. Управлявате капацитет

---

## Създаване на DynamoDB таблица

![Create Table](https://i.imgur.com/2XZtVnL.png)

1. Отворете DynamoDB конзолата
2. Кликнете "Create table"
3. Въведете име на таблицата
4. Изберете тип на първичния ключ
5. Конфигурирайте капацитет и настройки
6. Кликнете "Create"

---

## Конфигуриране на капацитет и настройки

- **Provisioned** - фиксиран капацитет за четене и запис
- **On-demand** - автоматично мащабиране
- **Encryption** - криптиране на данните
- **Point-in-time recovery** - възстановяване на данни
- **Time to live (TTL)** - автоматично изтриване на стари данни
- **Tags** - метаданни за таблицата

---

## Конфигуриране на индекси

![Indexes](https://i.imgur.com/3XZtVnL.png)

### Глобални вторични индекси (GSI)
- Индекси върху атрибути, различни от първичния ключ
- Подобряват производителността на заявките

### Локални вторични индекси (LSI)
- Индекси върху атрибути, различни от ключа на сортиране
- Подобряват производителността на заявките

---

## Основни операции в DynamoDB (CRUD)

![CRUD](https://i.imgur.com/4XZtVnL.png)

- **Create** - създаване на елементи
- **Read** - четене на елементи
- **Update** - актуализиране на елементи
- **Delete** - изтриване на елементи

---

## Създаване на елементи (Create)

### Чрез AWS Management Console
1. Изберете таблицата
2. Отидете на "Items"
3. Кликнете "Create item"
4. Въведете стойности за атрибутите
5. Кликнете "Save"

### Чрез AWS CLI
```bash
aws dynamodb put-item \
  --table-name YourTableName \
  --item '{
    "UserId": {"S": "user123"},
    "Name": {"S": "John Doe"},
    "Email": {"S": "john.doe@example.com"}
  }'
```

---

## Четене на елементи (Read)

### Чрез AWS Management Console
1. Изберете таблицата
2. Отидете на "Items"
3. Използвайте филтри за търсене

### Чрез AWS CLI
```bash
# Получаване на елемент по ключ
aws dynamodb get-item \
  --table-name YourTableName \
  --key '{"UserId": {"S": "user123"}}'

# Сканиране на таблица
aws dynamodb scan \
  --table-name YourTableName

# Заявка по индекс
aws dynamodb query \
  --table-name YourTableName \
  --index-name YourIndexName \
  --key-condition-expression "Email = :email" \
  --expression-attribute-values '{":email": {"S": "john.doe@example.com"}}'
```

---

## Актуализиране на елементи (Update)

### Чрез AWS Management Console
1. Изберете таблицата
2. Отидете на "Items"
3. Изберете елемента
4. Кликнете "Edit"
5. Променете стойностите
6. Кликнете "Save"

### Чрез AWS CLI
```bash
aws dynamodb update-item \
  --table-name YourTableName \
  --key '{"UserId": {"S": "user123"}}' \
  --update-expression "SET Email = :email" \
  --expression-attribute-values '{":email": {"S": "new.email@example.com"}}'
```

---

## Изтриване на елементи (Delete)

### Чрез AWS Management Console
1. Изберете таблицата
2. Отидете на "Items"
3. Изберете елемента
4. Кликнете "Delete"
5. Потвърдете изтриването

### Чрез AWS CLI
```bash
aws dynamodb delete-item \
  --table-name YourTableName \
  --key '{"UserId": {"S": "user123"}}'
```

---

## Използване на индекси за оптимизация на заявки

![Indexes](https://i.imgur.com/5XZtVnL.png)

### Глобални вторични индекси (GSI)
- Индекси върху атрибути, различни от първичния ключ
- Подобряват производителността на заявките

### Локални вторични индекси (LSI)
- Индекси върху атрибути, различни от ключа на сортиране
- Подобряват производителността на заявките

---

## Пример за създаване на GSI

```bash
aws dynamodb update-table \
  --table-name YourTableName \
  --attribute-definitions AttributeName=Email,AttributeType=S \
  --global-secondary-index-updates \
    '[{"Create":{"IndexName":"EmailIndex","KeySchema":[{"AttributeName":"Email","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"},"ProvisionedThroughput":{"ReadCapacityUnits":5,"WriteCapacityUnits":5}}}]'
```

---

## Пример за създаване на LSI

```bash
aws dynamodb update-table \
  --table-name YourTableName \
  --attribute-definitions AttributeName=Timestamp,AttributeType=N \
  --local-secondary-index-updates \
    '[{"Create":{"IndexName":"TimestampIndex","KeySchema":[{"AttributeName":"UserId","KeyType":"HASH"},{"AttributeName":"Timestamp","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"}}}]'
```

---

## Практически проект: Система за управление на задачи

![Архитектура](https://i.imgur.com/6XZtVnL.png)

1. Потребителят създава задача чрез уеб интерфейс
2. Данните за задачата се записват в DynamoDB таблица
3. Потребителят може да преглежда, актуализира и изтрива задачи

---

## Стъпка 1: Създаване на DynamoDB таблица

- Име: `Tasks`
- Partition key: `TaskId`
- Sort key: `UserId`

---

## Стъпка 2: Създаване на IAM роля

Разрешения:
- `AWSLambdaBasicExecutionRole`
- `AmazonDynamoDBFullAccess`

---

## Стъпка 3: Създаване на Lambda функции

### Функция за създаване на задача (Node.js)

```javascript
const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB.DocumentClient();
const { v4: uuidv4 } = require('uuid');

exports.handler = async (event) => {
    const { userId, title, description } = JSON.parse(event.body);
    const taskId = uuidv4();
    
    const params = {
        TableName: 'Tasks',
        Item: {
            TaskId: taskId,
            UserId: userId,
            Title: title,
            Description: description,
            CreatedAt: new Date().toISOString()
        }
    };
    
    await dynamodb.put(params).promise();
    
    return {
        statusCode: 201,
        body: JSON.stringify({ message: 'Task created', taskId })
    };
};
```

---

## Функция за четене на задачи (Node.js)

```javascript
const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB.DocumentClient();

exports.handler = async (event) => {
    const { userId } = event.queryStringParameters;
    
    const params = {
        TableName: 'Tasks',
        KeyConditionExpression: 'UserId = :userId',
        ExpressionAttributeValues: {
            ':userId': userId
        }
    };
    
    const result = await dynamodb.query(params).promise();
    
    return {
        statusCode: 200,
        body: JSON.stringify(result.Items)
    };
};
```

---

## Функция за актуализиране на задача (Node.js)

```javascript
const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB.DocumentClient();

exports.handler = async (event) => {
    const { taskId, userId, title, description } = JSON.parse(event.body);
    
    const params = {
        TableName: 'Tasks',
        Key: {
            TaskId: taskId,
            UserId: userId
        },
        UpdateExpression: 'SET Title = :title, Description = :description',
        ExpressionAttributeValues: {
            ':title': title,
            ':description': description
        }
    };
    
    await dynamodb.update(params).promise();
    
    return {
        statusCode: 200,
        body: JSON.stringify({ message: 'Task updated' })
    };
};
```

---

## Функция за изтриване на задача (Node.js)

```javascript
const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB.DocumentClient();

exports.handler = async (event) => {
    const { taskId, userId } = JSON.parse(event.body);
    
    const params = {
        TableName: 'Tasks',
        Key: {
            TaskId: taskId,
            UserId: userId
        }
    };
    
    await dynamodb.delete(params).promise();
    
    return {
        statusCode: 200,
        body: JSON.stringify({ message: 'Task deleted' })
    };
};
```

---

## Стъпка 4: Пакетиране на Lambda функции

```bash
mkdir create-task && cd create-task
npm init -y
npm install aws-sdk uuid
# Създайте index.js с кода на функцията
zip -r function.zip index.js node_modules
```

---

## Стъпка 5: Създаване на Lambda функции

1. Създайте функции за създаване, четене, актуализиране и изтриване на задачи
2. Качете ZIP файловете
3. Задайте `index.handler` като handler
4. Изберете IAM ролята
5. Увеличете timeout и памет

---

## Стъпка 6: Създаване на API Gateway

1. Създайте нов REST API
2. Създайте ресурси и методи за създаване, четене, актуализиране и изтриване на задачи
3. Интегрирайте методите с Lambda функциите

---

## Стъпка 7: Тестване на системата

1. Използвайте Postman или друг инструмент за тестване на API
2. Създайте, прочетете, актуализирайте и изтрийте задачи
3. Проверете данните в DynamoDB таблицата

---

## Въпроси?

![Въпроси](https://i.imgur.com/7XZtVnL.png)
