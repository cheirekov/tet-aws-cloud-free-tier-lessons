# Урок 6: Настройка на S3 за съхранение на файлове

## Цели на урока
- Да разберем какво е Amazon S3 и как работи
- Да се научим да създаваме и конфигурираме S3 buckets
- Да се запознаем с различните класове на съхранение в S3
- Да се научим да качваме, изтегляме и управляваме обекти в S3
- Да разберем как да настроим статично уеб хостване с S3

## Какво е Amazon S3 и как работи?

### Дефиниция на Amazon S3
Amazon Simple Storage Service (S3) е обектно хранилище, което предлага водеща в индустрията мащабируемост, наличност на данни, сигурност и производителност. S3 е проектиран за съхранение и извличане на всякакво количество данни от всяко място - уебсайтове, мобилни приложения, корпоративни приложения и данни от IoT сензори или устройства.

### Основни концепции на S3
- **Buckets** - контейнери за съхранение на обекти. Всеки bucket има глобално уникално име.
- **Objects** - основните единици, съхранявани в S3. Обектът се състои от данни и метаданни.
- **Keys** - уникален идентификатор на обект в bucket. Комбинацията от bucket, key и версия (опционално) уникално идентифицира всеки обект.
- **Regions** - географски области, където Amazon S3 съхранява buckets, които създавате.
- **Endpoints** - URL адреси, използвани за достъп до S3.
- **Access Control** - управление на достъпа до buckets и обекти.
- **Storage Classes** - различни класове на съхранение, оптимизирани за различни случаи на употреба.

### Как работи S3?
1. **Създавате bucket** - първо създавате bucket с уникално име в избран от вас регион.
2. **Качвате обекти** - качвате файлове (обекти) в bucket.
3. **Управлявате достъпа** - контролирате кой може да достъпва вашите обекти чрез различни механизми за контрол на достъпа.
4. **Управлявате обекти** - организирате, изтегляте, изтривате и управлявате версиите на вашите обекти.
5. **Анализирате използването** - следите използването и разходите за вашите S3 ресурси.

## Класове на съхранение в S3

Amazon S3 предлага различни класове на съхранение, проектирани за различни случаи на употреба. Изборът на правилния клас на съхранение може да помогне за оптимизиране на разходите.

### S3 Standard
- **Характеристики**: Висока наличност и издръжливост, проектиран за често достъпвани данни.
- **Случаи на употреба**: Уебсайтове, разпространение на съдържание, мобилни и игрови приложения, анализ на големи данни.
- **Наличност**: 99.99%
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: Няма

### S3 Intelligent-Tiering
- **Характеристики**: Автоматично премества обекти между два слоя на достъп (чест и рядък) въз основа на променящите се модели на достъп.
- **Случаи на употреба**: Данни с неизвестни или променящи се модели на достъп.
- **Наличност**: 99.9%
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: 30 дни

### S3 Standard-IA (Infrequent Access)
- **Характеристики**: По-ниска цена от S3 Standard, но с такса за извличане.
- **Случаи на употреба**: Данни, които се достъпват по-рядко, но изискват бърз достъп при необходимост.
- **Наличност**: 99.9%
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: 30 дни

### S3 One Zone-IA
- **Характеристики**: Като Standard-IA, но съхранява данни само в една зона на наличност.
- **Случаи на употреба**: Некритични данни, които могат да бъдат пресъздадени и се достъпват рядко.
- **Наличност**: 99.5%
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: 30 дни

### S3 Glacier
- **Характеристики**: Много ниска цена, проектиран за архивиране, с време за извличане от минути до часове.
- **Случаи на употреба**: Архивиране на данни, дългосрочно съхранение.
- **Наличност**: Не е приложимо (архивно съхранение)
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: 90 дни

### S3 Glacier Deep Archive
- **Характеристики**: Най-ниската цена, проектиран за дългосрочно архивиране, с време за извличане до 12 часа.
- **Случаи на употреба**: Дългосрочно съхранение, архиви, които се достъпват веднъж или два пъти годишно.
- **Наличност**: Не е приложимо (архивно съхранение)
- **Издръжливост**: 99.999999999% (11 деветки)
- **Минимален период на съхранение**: 180 дни

## Създаване и конфигуриране на S3 bucket

### Стъпки за създаване на S3 bucket чрез AWS Management Console

#### 1. Отворете S3 конзолата
1. Влезте в AWS Management Console
2. Отидете на услугата "S3"
3. Кликнете "Create bucket"

#### 2. Конфигурирайте общи настройки
1. Въведете уникално име на bucket (глобално уникално в целия AWS)
2. Изберете регион (препоръчително е да изберете регион близо до вашите потребители)
3. Кликнете "Next"

#### 3. Конфигурирайте опции
1. Изберете опции за версиониране:
   - **Versioning**: Позволява съхранение на множество версии на обект
   - **Server access logging**: Записва заявки за достъп до bucket
   - **Tags**: Добавяне на метаданни към bucket
   - **Default encryption**: Автоматично криптиране на обекти
2. Кликнете "Next"

#### 4. Конфигурирайте разрешения
1. Настройте публичен достъп:
   - По подразбиране, всички настройки за блокиране на публичен достъп са включени
   - Изключете ги само ако имате специфична нужда от публичен достъп (например за статично уеб хостване)
2. Настройте ACLs (Access Control Lists) ако е необходимо
3. Настройте Bucket Policy ако е необходимо
4. Кликнете "Next"

#### 5. Преглед и създаване
1. Прегледайте всички настройки
2. Кликнете "Create bucket"

### Конфигуриране на допълнителни настройки на bucket

#### Настройка на жизнен цикъл (Lifecycle Rules)
Lifecycle Rules ви позволяват да автоматизирате прехвърлянето на обекти между класове на съхранение или изтриването им след определен период.

1. В S3 конзолата, изберете вашия bucket
2. Отидете на раздела "Management"
3. Кликнете "Create lifecycle rule"
4. Конфигурирайте правилото:
   - Име на правилото
   - Обхват (всички обекти или обекти с определен префикс/таг)
   - Действия (преход между класове на съхранение, изтичане на текущи/предишни версии)
   - Времеви периоди за всяко действие
5. Кликнете "Create rule"

#### Настройка на CORS (Cross-Origin Resource Sharing)
CORS позволява уеб приложения, хоствани в един домейн, да достъпват ресурси от друг домейн.

1. В S3 конзолата, изберете вашия bucket
2. Отидете на раздела "Permissions"
3. Превъртете надолу до "Cross-origin resource sharing (CORS)"
4. Кликнете "Edit"
5. Въведете CORS конфигурация в JSON формат:
   ```json
   [
     {
       "AllowedHeaders": ["*"],
       "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
       "AllowedOrigins": ["http://www.example.com"],
       "ExposeHeaders": ["ETag"]
     }
   ]
   ```
6. Кликнете "Save changes"

#### Настройка на Event Notifications
Event Notifications позволяват задействане на действия (например Lambda функции, SQS опашки или SNS теми) при определени събития в bucket.

1. В S3 конзолата, изберете вашия bucket
2. Отидете на раздела "Properties"
3. Превъртете надолу до "Event notifications"
4. Кликнете "Create event notification"
5. Конфигурирайте известието:
   - Име на събитието
   - Типове събития (например създаване на обект, изтриване на обект)
   - Префикс/суфикс филтри (опционално)
   - Дестинация (Lambda, SQS, SNS)
6. Кликнете "Save changes"

## Качване, изтегляне и управление на обекти в S3

### Качване на обекти в S3

#### Чрез AWS Management Console
1. В S3 конзолата, изберете вашия bucket
2. Кликнете "Upload"
3. Кликнете "Add files" или "Add folder" и изберете файловете/папките за качване
4. Конфигурирайте допълнителни настройки (опционално):
   - Storage class
   - Encryption
   - Metadata
   - Tags
   - Permissions
5. Кликнете "Upload"

#### Чрез AWS CLI
```bash
# Качване на файл
aws s3 cp file.txt s3://your-bucket-name/

# Качване на папка рекурсивно
aws s3 cp folder/ s3://your-bucket-name/folder/ --recursive

# Качване с определен клас на съхранение
aws s3 cp file.txt s3://your-bucket-name/ --storage-class STANDARD_IA
```

### Изтегляне на обекти от S3

#### Чрез AWS Management Console
1. В S3 конзолата, изберете вашия bucket
2. Намерете и изберете обекта, който искате да изтеглите
3. Кликнете "Download" или "Download as" (за избор на местоположение)

#### Чрез AWS CLI
```bash
# Изтегляне на файл
aws s3 cp s3://your-bucket-name/file.txt file.txt

# Изтегляне на папка рекурсивно
aws s3 cp s3://your-bucket-name/folder/ folder/ --recursive
```

### Управление на обекти в S3

#### Преименуване/Преместване на обекти
В S3 няма директна операция "преименуване". Вместо това, трябва да копирате обекта с ново име и след това да изтриете оригинала.

##### Чрез AWS Management Console
1. В S3 конзолата, изберете вашия bucket
2. Изберете обекта, който искате да преименувате
3. Кликнете "Copy"
4. Въведете новото име/път в полето "Destination"
5. Кликнете "Copy"
6. Изберете оригиналния обект и кликнете "Delete"

##### Чрез AWS CLI
```bash
# Копиране на обект с ново име
aws s3 cp s3://your-bucket-name/old-name.txt s3://your-bucket-name/new-name.txt

# Изтриване на оригиналния обект
aws s3 rm s3://your-bucket-name/old-name.txt
```

#### Изтриване на обекти

##### Чрез AWS Management Console
1. В S3 конзолата, изберете вашия bucket
2. Изберете обекта(ите), който искате да изтриете
3. Кликнете "Delete"
4. Потвърдете изтриването, като въведете "delete" в полето за потвърждение
5. Кликнете "Delete objects"

##### Чрез AWS CLI
```bash
# Изтриване на файл
aws s3 rm s3://your-bucket-name/file.txt

# Изтриване на папка рекурсивно
aws s3 rm s3://your-bucket-name/folder/ --recursive
```

#### Управление на версии на обекти
Ако версионирането е включено за вашия bucket, можете да достъпвате и управлявате предишни версии на обекти.

##### Чрез AWS Management Console
1. В S3 конзолата, изберете вашия bucket
2. Кликнете върху името на обекта
3. Кликнете върху раздела "Versions"
4. Тук можете да видите всички версии на обекта, да ги изтегляте или изтривате

##### Чрез AWS CLI
```bash
# Списък на всички версии на обект
aws s3api list-object-versions --bucket your-bucket-name --prefix file.txt

# Изтегляне на конкретна версия на обект
aws s3api get-object --bucket your-bucket-name --key file.txt --version-id versionId file.txt
```

## Настройка на статично уеб хостване с S3

Amazon S3 може да хоства статични уебсайтове, които включват HTML, CSS, JavaScript, изображения и други файлове на клиентската страна.

### Стъпки за настройка на статично уеб хостване

#### 1. Създайте bucket и качете уеб файлове
1. Създайте нов bucket или използвайте съществуващ
2. Качете вашите уеб файлове (HTML, CSS, JavaScript, изображения и т.н.)
3. Уверете се, че имате файл index.html в основната директория

#### 2. Настройте публичен достъп
1. В S3 конзолата, изберете вашия bucket
2. Отидете на раздела "Permissions"
3. Кликнете "Edit" в секцията "Block public access"
4. Премахнете отметката от "Block all public access"
5. Кликнете "Save changes"
6. Потвърдете промяната, като въведете "confirm" в полето за потвърждение

#### 3. Добавете Bucket Policy за публичен достъп
1. В раздела "Permissions", кликнете "Bucket Policy"
2. Въведете следната политика (заменете "your-bucket-name" с името на вашия bucket):
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "PublicReadGetObject",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::your-bucket-name/*"
       }
     ]
   }
   ```
3. Кликнете "Save changes"

#### 4. Активирайте статично уеб хостване
1. Отидете на раздела "Properties"
2. Превъртете надолу до "Static website hosting"
3. Кликнете "Edit"
4. Изберете "Enable"
5. За "Index document", въведете "index.html"
6. За "Error document" (опционално), въведете "error.html"
7. Кликнете "Save changes"

#### 5. Достъп до вашия уебсайт
1. В секцията "Static website hosting", ще видите URL адреса на вашия уебсайт
2. Кликнете върху URL адреса или го копирайте и отворете в браузър

### Настройка на персонализиран домейн с Route 53 (опционално)

Ако имате регистриран домейн в Route 53, можете да го използвате вместо URL адреса на S3.

1. Създайте нов bucket с име, съвпадащо с вашия домейн (например www.example.com)
2. Настройте статично уеб хостване, както е описано по-горе
3. В Route 53 конзолата, създайте нов запис:
   - Изберете вашата хостинг зона
   - Кликнете "Create record"
   - Въведете поддомейн (например www) или оставете празно за основния домейн
   - Изберете тип "A - IPv4 address"
   - Включете "Alias"
   - За "Route traffic to", изберете "Alias to S3 website endpoint"
   - Изберете региона на вашия bucket
   - Изберете вашия bucket от падащото меню
   - Кликнете "Create records"

## Практическа задача: Създаване на статичен уебсайт с S3

### Задача 1: Създаване на S3 bucket
1. Създайте S3 bucket със следните параметри:
   - Име: уникално име по ваш избор
   - Регион: eu-central-1 (Frankfurt) или eu-west-1 (Ireland)
   - Блокиране на публичен достъп: Изключено
   - Версиониране: Включено
   - Encryption: Включено (SSE-S3)

### Задача 2: Създаване на прост уебсайт
1. Създайте следните файлове на вашия компютър:
   - index.html:
     ```html
     <!DOCTYPE html>
     <html>
     <head>
       <title>My S3 Website</title>
       <link rel="stylesheet" type="text/css" href="styles.css">
     </head>
     <body>
       <div class="container">
         <h1>Welcome to My S3 Website</h1>
         <p>This website is hosted on Amazon S3!</p>
         <img src="aws-logo.png" alt="AWS Logo">
       </div>
     </body>
     </html>
     ```
   - styles.css:
     ```css
     body {
       font-family: Arial, sans-serif;
       background-color: #f0f0f0;
       margin: 0;
       padding: 0;
     }
     .container {
       max-width: 800px;
       margin: 0 auto;
       padding: 20px;
       background-color: white;
       box-shadow: 0 0 10px rgba(0,0,0,0.1);
       text-align: center;
       margin-top: 50px;
     }
     h1 {
       color: #232f3e;
     }
     img {
       max-width: 200px;
       margin-top: 20px;
     }
     ```
2. Изтеглете лого на AWS и го запазете като "aws-logo.png"

### Задача 3: Качване на файловете в S3
1. Качете всички файлове (index.html, styles.css, aws-logo.png) в създадения bucket
2. Уверете се, че всички файлове имат правилните MIME типове:
   - index.html: text/html
   - styles.css: text/css
   - aws-logo.png: image/png

### Задача 4: Настройка на публичен достъп
1. Добавете Bucket Policy за публичен достъп до всички обекти

### Задача 5: Активиране на статично уеб хостване
1. Активирайте статично уеб хостване
2. Задайте index.html като индексен документ
3. Отворете URL адреса на уебсайта и проверете дали работи правилно

### Задача 6: Създаване на страница за грешка
1. Създайте файл error.html:
   ```html
   <!DOCTYPE html>
   <html>
   <head>
     <title>Error - My S3 Website</title>
     <link rel="stylesheet" type="text/css" href="styles.css">
   </head>
   <body>
     <div class="container">
       <h1>Oops! Something went wrong</h1>
       <p>The page you are looking for does not exist.</p>
       <a href="index.html">Go back to homepage</a>
     </div>
   </body>
   </html>
   ```
2. Качете файла в bucket
3. Задайте error.html като документ за грешка в настройките за статично уеб хостване
4. Тествайте страницата за грешка, като опитате да достъпите несъществуващ URL (например http://your-bucket-website-url/nonexistent.html)

## Допълнителни ресурси
- [Amazon S3 Documentation](https://docs.aws.amazon.com/s3/)
- [Amazon S3 Pricing](https://aws.amazon.com/s3/pricing/)
- [Amazon S3 Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/best-practices.html)
- [Static Website Hosting Documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html)
- [AWS CLI S3 Commands](https://docs.aws.amazon.com/cli/latest/reference/s3/)

## Въпроси за дискусия
1. Какви са предимствата на използването на S3 за съхранение на файлове спрямо традиционните файлови системи?
2. Как бихте избрали подходящ клас на съхранение за различни типове данни?
3. Какви мерки за сигурност бихте предприели за защита на чувствителни данни в S3?
