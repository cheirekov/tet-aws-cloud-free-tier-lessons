# Урок 4: Настройка на IAM потребители и роли

## Цели на урока
- Да разберем какво е IAM и защо е важен за сигурността
- Да се научим да създаваме и управляваме IAM потребители
- Да разберем концепцията за IAM роли и политики
- Да настроим AWS CLI с IAM credentials

## Какво е IAM и защо е важен?

### Дефиниция на IAM
AWS Identity and Access Management (IAM) е уеб услуга, която ви помага да контролирате сигурно достъпа до AWS ресурси. С IAM можете да управлявате кой е оторизиран да използва ресурси (автентикация) и какви ресурси могат да използват и по какъв начин (авторизация).

### Ключови компоненти на IAM
- **Потребители (Users)** - индивидуални акаунти за хора или приложения
- **Групи (Groups)** - колекции от потребители с общи разрешения
- **Роли (Roles)** - набор от разрешения, които могат да бъдат временно поети от потребители или услуги
- **Политики (Policies)** - документи, които дефинират разрешенията
- **Идентичности (Identities)** - ресурси, на които могат да бъдат прикрепени политики (потребители, групи, роли)

### Защо IAM е важен?
1. **Сигурност** - прилагане на принципа на най-малките привилегии
2. **Контрол на достъпа** - фино управление на това кой какво може да прави
3. **Одит** - проследяване на действията на потребителите
4. **Интеграция** - работи с всички AWS услуги
5. **Безплатен** - IAM е безплатна услуга, включена във всеки AWS акаунт

### Най-добри практики за IAM
1. **Не използвайте Root акаунта** за ежедневни задачи
2. **Създавайте индивидуални потребители** вместо споделени акаунти
3. **Използвайте групи** за управление на разрешения
4. **Прилагайте силни пароли** и политики за пароли
5. **Активирайте MFA** за привилегировани потребители
6. **Използвайте роли** за делегиране на разрешения
7. **Прилагайте принципа на най-малките привилегии**
8. **Редовно преглеждайте и актуализирайте** разрешенията

## Създаване и управление на IAM потребители

### Създаване на IAM потребител

#### Чрез AWS Management Console
1. Влезте в AWS Management Console
2. Отидете на услугата "IAM"
3. В навигационното меню вляво, кликнете "Users"
4. Кликнете "Add users"
5. Въведете име на потребителя
6. Изберете типа на достъпа:
   - **AWS Management Console access** - за достъп до конзолата
   - **Programmatic access** - за достъп чрез API, CLI или SDK
7. Ако сте избрали достъп до конзолата, задайте парола или генерирайте автоматично
8. Кликнете "Next: Permissions"

### Задаване на разрешения на потребител
Имате три опции за задаване на разрешения:
1. **Add user to group** - добавяне на потребителя към съществуваща група
2. **Copy permissions from existing user** - копиране на разрешения от друг потребител
3. **Attach existing policies directly** - директно прикрепяне на политики

За нашия курс, ще използваме третата опция:
1. Изберете "Attach existing policies directly"
2. Потърсете и изберете подходящи политики:
   - За администратор: "AdministratorAccess"
   - За разработчик: "PowerUserAccess"
   - За специфични услуги: например "AmazonS3FullAccess", "AmazonEC2FullAccess"
3. Кликнете "Next: Tags"

### Добавяне на тагове (опционално)
Таговете помагат за организиране и идентифициране на потребителите:
1. Кликнете "Add tag"
2. Въведете ключ (например "Department") и стойност (например "IT")
3. Кликнете "Next: Review"

### Преглед и създаване
1. Прегледайте информацията за потребителя
2. Кликнете "Create user"
3. **Важно**: Ако сте създали програмен достъп, запазете Access key ID и Secret access key или изтеглете CSV файла. Това е единственият път, когато можете да видите Secret access key!

### Управление на съществуващи потребители

#### Промяна на разрешения
1. В IAM конзолата, кликнете "Users"
2. Изберете потребителя, който искате да редактирате
3. Отидете на раздела "Permissions"
4. Кликнете "Add permissions" за добавяне на нови разрешения
5. За премахване на разрешения, изберете политиката и кликнете "Remove"

#### Промяна на парола
1. В IAM конзолата, кликнете "Users"
2. Изберете потребителя
3. Отидете на раздела "Security credentials"
4. В секцията "Console password", кликнете "Manage"
5. Изберете "Set password" и въведете нова парола

#### Деактивиране/Изтриване на потребител
1. В IAM конзолата, кликнете "Users"
2. Изберете потребителя
3. За деактивиране на достъп до конзолата: в раздела "Security credentials", деактивирайте "Console access"
4. За изтриване: кликнете "Delete" в горната част на страницата и потвърдете

## IAM групи

### Какво са IAM групи?
IAM групите са колекции от IAM потребители. Групите позволяват да зададете разрешения на множество потребители наведнъж, което улеснява управлението на разрешенията.

### Създаване на IAM група
1. В IAM конзолата, кликнете "User groups" в навигационното меню вляво
2. Кликнете "Create group"
3. Въведете име на групата (например "Developers", "Administrators")
4. В секцията "Attach permissions policies", изберете политиките, които искате да прикрепите към групата
5. Кликнете "Create group"

### Добавяне на потребители към група
1. В IAM конзолата, кликнете "User groups"
2. Изберете групата
3. Отидете на раздела "Users"
4. Кликнете "Add users"
5. Изберете потребителите, които искате да добавите
6. Кликнете "Add users"

### Премахване на потребители от група
1. В IAM конзолата, кликнете "User groups"
2. Изберете групата
3. Отидете на раздела "Users"
4. Изберете потребителя, който искате да премахнете
5. Кликнете "Remove"

## IAM политики

### Какво са IAM политики?
IAM политиките са JSON документи, които дефинират разрешенията. Те определят какви действия са разрешени или забранени за AWS ресурси.

### Типове политики
1. **AWS управлявани политики** - създадени и управлявани от AWS
2. **Политики, управлявани от клиента** - създадени и управлявани от вас
3. **Вградени политики** - политики, вградени директно в потребител, група или роля

### Структура на IAM политика
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::example-bucket"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::example-bucket/*"
    }
  ]
}
```

Основни елементи:
- **Version** - версия на езика на политиката
- **Statement** - масив от отделни изявления
- **Effect** - "Allow" или "Deny"
- **Action** - действия, които се разрешават или забраняват
- **Resource** - ресурси, за които се прилага изявлението
- **Condition** (опционално) - условия, при които се прилага политиката

### Създаване на персонализирана политика
1. В IAM конзолата, кликнете "Policies" в навигационното меню вляво
2. Кликнете "Create policy"
3. Изберете метод за създаване:
   - **Visual editor** - графичен интерфейс за създаване на политики
   - **JSON** - директно редактиране на JSON документа
4. Конфигурирайте разрешенията:
   - Изберете услуга (например "S3")
   - Изберете действия (например "ListBucket", "GetObject")
   - Изберете ресурси (например конкретен bucket)
   - Добавете условия (опционално)
5. Кликнете "Next: Tags"
6. Добавете тагове (опционално)
7. Кликнете "Next: Review"
8. Въведете име и описание на политиката
9. Кликнете "Create policy"

## IAM роли

### Какво са IAM роли?
IAM ролите са подобни на потребителите, но не са свързани с конкретно лице. Вместо това, ролите могат да бъдат поети от всеки, който се нуждае от тях - потребители, приложения или AWS услуги.

### Кога да използваме роли?
1. **Делегиране на достъп между акаунти** - позволяване на потребители от един акаунт да достъпват ресурси в друг
2. **Достъп за AWS услуги** - позволяване на AWS услуги да действат от ваше име
3. **Достъп за приложения, работещи на EC2 инстанции** - предоставяне на временни credentials на приложения
4. **Федерация на идентичности** - позволяване на потребители от външни системи за идентичност да достъпват AWS ресурси

### Създаване на IAM роля
1. В IAM конзолата, кликнете "Roles" в навигационното меню вляво
2. Кликнете "Create role"
3. Изберете тип на доверено лице:
   - **AWS service** - за AWS услуги като EC2, Lambda
   - **Another AWS account** - за достъп от друг AWS акаунт
   - **Web identity** - за федерация с доставчици като Google, Facebook
   - **SAML 2.0 federation** - за федерация с корпоративни системи за идентичност
4. Конфигурирайте доверието според избрания тип
5. Кликнете "Next: Permissions"
6. Изберете политики, които искате да прикрепите към ролята
7. Кликнете "Next: Tags"
8. Добавете тагове (опционално)
9. Кликнете "Next: Review"
10. Въведете име и описание на ролята
11. Кликнете "Create role"

### Пример: Създаване на роля за EC2 инстанция
1. В IAM конзолата, кликнете "Roles" → "Create role"
2. Изберете "AWS service" и след това "EC2"
3. Кликнете "Next: Permissions"
4. Изберете политики (например "AmazonS3ReadOnlyAccess" за достъп до S3)
5. Кликнете "Next: Tags"
6. Добавете тагове (опционално)
7. Кликнете "Next: Review"
8. Въведете име (например "EC2-S3-ReadOnly") и описание
9. Кликнете "Create role"

## Настройка на AWS CLI с IAM credentials

### Какво е AWS CLI?
AWS Command Line Interface (CLI) е унифициран инструмент за управление на AWS услуги от командния ред. С един инструмент за изтегляне и конфигуриране, можете да контролирате множество AWS услуги от командния ред.

### Инсталиране на AWS CLI

#### За Windows
1. Изтеглете инсталационния файл от [официалния сайт](https://aws.amazon.com/cli/)
2. Стартирайте инсталационния файл и следвайте инструкциите
3. Отворете Command Prompt или PowerShell и въведете `aws --version` за да проверите инсталацията

#### За macOS
1. Използвайте Homebrew: `brew install awscli`
2. Или изтеглете инсталационния пакет от [официалния сайт](https://aws.amazon.com/cli/)
3. Отворете Terminal и въведете `aws --version` за да проверите инсталацията

#### За Linux
1. Използвайте package manager:
   - Ubuntu/Debian: `sudo apt-get install awscli`
   - Amazon Linux/RHEL/CentOS: `sudo yum install awscli`
2. Или използвайте pip: `pip install awscli`
3. Отворете Terminal и въведете `aws --version` за да проверите инсталацията

### Конфигуриране на AWS CLI
За да използвате AWS CLI, трябва да го конфигурирате с вашите IAM credentials:

1. Отворете терминал или командния ред
2. Въведете `aws configure`
3. Въведете следната информация:
   - AWS Access Key ID: [вашият access key]
   - AWS Secret Access Key: [вашият secret key]
   - Default region name: [предпочитан регион, например eu-central-1]
   - Default output format: [предпочитан формат, например json]

### Получаване на Access Keys за IAM потребител
1. В IAM конзолата, кликнете "Users"
2. Изберете потребителя
3. Отидете на раздела "Security credentials"
4. В секцията "Access keys", кликнете "Create access key"
5. Изберете "Command Line Interface (CLI)"
6. Поставете отметка на "I understand..." и кликнете "Next"
7. Опционално добавете таг и кликнете "Create access key"
8. Запазете Access key ID и Secret access key или изтеглете CSV файла

### Тестване на AWS CLI
След конфигурирането, можете да тествате CLI с прости команди:

```bash
# Списък на всички S3 buckets
aws s3 ls

# Информация за текущия потребител
aws sts get-caller-identity

# Списък на EC2 инстанции
aws ec2 describe-instances

# Списък на IAM потребители
aws iam list-users
```

### Управление на множество профили
Можете да конфигурирате множество профили за различни AWS акаунти или роли:

1. Създаване на нов профил:
```bash
aws configure --profile profilename
```

2. Използване на конкретен профил:
```bash
aws s3 ls --profile profilename
```

3. Задаване на профил по подразбиране за текущата сесия:
```bash
export AWS_PROFILE=profilename  # Linux/macOS
set AWS_PROFILE=profilename     # Windows
```

## Практическа задача: Настройка на IAM потребители и роли

### Задача 1: Създаване на IAM потребители
1. Създайте IAM потребител с име "Developer" с достъп до конзолата и програмен достъп
2. Прикрепете политиката "PowerUserAccess" към потребителя
3. Запазете credentials за програмен достъп

### Задача 2: Създаване на IAM група
1. Създайте IAM група с име "Developers"
2. Прикрепете политиките "AmazonS3FullAccess" и "AmazonEC2ReadOnlyAccess" към групата
3. Добавете потребителя "Developer" към групата

### Задача 3: Създаване на персонализирана политика
1. Създайте персонализирана политика, която позволява:
   - Четене на обекти от S3 bucket с име "example-bucket"
   - Създаване на EC2 инстанции само от тип t2.micro или t3.micro
2. Прикрепете политиката към групата "Developers"

### Задача 4: Създаване на IAM роля
1. Създайте IAM роля за EC2 услугата
2. Прикрепете политиката "AmazonS3ReadOnlyAccess" към ролята
3. Дайте на ролята име "EC2-S3-ReadOnly"

### Задача 5: Настройка на AWS CLI
1. Инсталирайте AWS CLI на вашия компютър
2. Конфигурирайте CLI с credentials на потребителя "Developer"
3. Тествайте CLI с команда `aws iam get-user`

## Допълнителни ресурси
- [AWS IAM Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
- [AWS IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [AWS CLI Documentation](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html)
- [IAM Policy Simulator](https://policysim.aws.amazon.com/)
- [AWS Policy Generator](https://awspolicygen.s3.amazonaws.com/policygen.html)

## Въпроси за дискусия
1. Защо е важно да следваме принципа на най-малките привилегии при създаване на IAM потребители и роли?
2. Какви са предимствата на използването на IAM групи вместо директно прикрепяне на политики към потребители?
3. В какви сценарии бихте използвали IAM роли вместо IAM потребители?
