# Използване на AWS Lambda за безсървърни функции

---

## Какво ще научим днес?

- Какво е AWS Lambda и безсървърно изчисление
- Как да създаваме и конфигурираме Lambda функции
- Различни тригери за Lambda функции
- Наблюдение и дебъгване на Lambda функции
- Практически проект с Lambda, S3 и DynamoDB

---

## Какво е AWS Lambda?

![Lambda](https://i.imgur.com/1XZtVnL.png)

AWS Lambda е изчислителна услуга, която ви позволява да изпълнявате код без да осигурявате или управлявате сървъри

---

## Концепция за безсървърно изчисление

- **Без управление на сървъри** - фокус върху кода, не инфраструктурата
- **Автоматично мащабиране** - от няколко до хиляди заявки в секунда
- **Плащане според използването** - само за изчислителното време
- **Висока наличност** - вградена в платформата
- **Събитийно задвижвано** - изпълнение в отговор на събития

---

## Предимства на AWS Lambda

![Предимства](https://i.imgur.com/2XZtVnL.png)

1. Без управление на сървъри
2. Непрекъснато мащабиране
3. Икономическа ефективност
4. Бързина на изпълнение
5. Интеграция с други AWS услуги
6. Поддръжка на множество езици

---

## Ограничения на AWS Lambda

- Временно съхранение: 512 MB в `/tmp`
- Време за изпълнение: максимум 15 минути
- Размер на пакета: до 50 MB компресиран
- Памет: от 128 MB до 10 GB
- Конкурентни изпълнения: по подразбиране 1000
- Студен старт: забавяне при първоначално изпълнение

---

## Поддържани езици и рънтайми

![Езици](https://i.imgur.com/3XZtVnL.png)

- Node.js (JavaScript)
- Python
- Java
- Go
- .NET Core (C#)
- Ruby

---

## Създаване на Lambda функция

![Създаване](https://i.imgur.com/4XZtVnL.png)

1. Отворете Lambda конзолата
2. Кликнете "Create function"
3. Изберете опция за създаване
4. Конфигурирайте основни настройки
5. Напишете код за функцията
6. Конфигурирайте допълнителни настройки

---

## Пример за Node.js Lambda функция

```javascript
exports.handler = async (event) => {
    console.log('Event: ', JSON.stringify(event, null, 2));
    
    const response = {
        statusCode: 200,
        body: JSON.stringify('Hello from Lambda!'),
    };
    
    return response;
};
```

---

## Пример за Python Lambda функция

```python
import json

def lambda_handler(event, context):
    print('Event: ', json.dumps(event))
    
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }
```

---

## Конфигуриране на Lambda функция

![Конфигурация](https://i.imgur.com/5XZtVnL.png)

- **General configuration**: описание, памет, timeout
- **Permissions**: IAM роля за достъп до ресурси
- **Environment variables**: променливи на средата
- **Tags**: метаданни за организиране

---

## Създаване чрез AWS CLI

```bash
# Създаване на Lambda функция
aws lambda create-function \
  --function-name MyFunction \
  --runtime nodejs14.x \
  --role arn:aws:iam::123456789012:role/lambda-ex \
  --handler index.handler \
  --zip-file fileb://function.zip
```

---

## Създаване чрез AWS SAM

AWS Serverless Application Model (SAM) е фреймуърк за изграждане на безсървърни приложения

```yaml
Resources:
  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: hello-world/
      Handler: app.lambdaHandler
      Runtime: nodejs14.x
      Events:
        HelloWorld:
          Type: Api
          Properties:
            Path: /hello
            Method: get
```

---

## Тригери за Lambda функции

![Тригери](https://i.imgur.com/6XZtVnL.png)

Тригерите са услуги или ресурси, които извикват вашата Lambda функция

---

## Основни типове тригери

1. **API Gateway** - HTTP endpoints
2. **S3** - събития при промяна на обекти
3. **DynamoDB** - промени в таблица
4. **CloudWatch Events / EventBridge** - график или събития
5. **SNS** - съобщения в тема
6. **SQS** - съобщения в опашка
7. **Cognito** - събития за потребителски акаунти

---

## Добавяне на тригер

![Добавяне на тригер](https://i.imgur.com/7XZtVnL.png)

1. Изберете вашата функция
2. Отидете на "Configuration" > "Triggers"
3. Кликнете "Add trigger"
4. Изберете тип на тригера
5. Конфигурирайте настройките
6. Кликнете "Add"

---

## Наблюдение с CloudWatch Logs

![CloudWatch](https://i.imgur.com/8XZtVnL.png)

- Автоматична интеграция с CloudWatch Logs
- Преглед на логове в конзолата
- Добавяне на логове в кода

---

## Добавяне на логове в кода (Node.js)

```javascript
exports.handler = async (event) => {
    console.log('Event received:', JSON.stringify(event));
    
    try {
        // Вашата логика тук
        console.log('Operation successful');
    } catch (error) {
        console.error('Error occurred:', error);
        throw error;
    }
    
    return { statusCode: 200, body: 'Success' };
};
```

---

## Наблюдение с CloudWatch Metrics

![Metrics](https://i.imgur.com/9XZtVnL.png)

Основни метрики:
- **Invocations** - брой извиквания
- **Duration** - време за изпълнение
- **Errors** - брой грешки
- **Throttles** - брой ограничени заявки
- **ConcurrentExecutions** - едновременни изпълнения

---

## Дебъгване на Lambda функции

- **Локално тестване с AWS SAM**
  ```bash
  sam local invoke -e events/event.json
  ```

- **Използване на X-Ray за трасиране**
  - Активирайте X-Ray в настройките
  - Добавете AWS X-Ray SDK към кода

- **AWS Lambda Power Tuning**
  - Оптимизиране на настройките за памет/CPU

---

## Практически проект: Система за обработка на изображения

![Архитектура](https://i.imgur.com/0XZtVnL.png)

1. Потребителят качва изображение в S3 bucket
2. S3 събитието задейства Lambda функция
3. Lambda функцията обработва изображението
4. Обработеното изображение се запазва в друг S3 bucket
5. Метаданните се записват в DynamoDB

---

## Стъпка 1: Създаване на S3 buckets

- `image-upload-bucket` - за оригинални изображения
- `image-processed-bucket` - за обработени изображения

---

## Стъпка 2: Създаване на DynamoDB таблица

- Име: `ImageMetadata`
- Partition key: `imageId`

---

## Стъпка 3: Създаване на IAM роля

Разрешения:
- `AWSLambdaBasicExecutionRole`
- `AmazonS3ReadOnlyAccess`
- `AmazonS3FullAccess`
- `AmazonDynamoDBFullAccess`

---

## Стъпка 4: Създаване на Lambda функция

```javascript
const AWS = require('aws-sdk');
const sharp = require('sharp');
const s3 = new AWS.S3();
const dynamodb = new AWS.DynamoDB.DocumentClient();
const { v4: uuidv4 } = require('uuid');

exports.handler = async (event) => {
    // Извличане на изображението от S3
    // Обработка с Sharp
    // Запазване на обработеното изображение
    // Записване на метаданни в DynamoDB
};
```

---

## Стъпка 5: Пакетиране на функцията

```bash
mkdir image-processor && cd image-processor
npm init -y
npm install sharp uuid aws-sdk
# Създайте index.js с кода на функцията
zip -r function.zip index.js node_modules
```

---

## Стъпка 6: Създаване на Lambda функция

1. Създайте функция с име `ImageProcessor`
2. Качете ZIP файла
3. Задайте `index.handler` като handler
4. Изберете IAM ролята
5. Увеличете timeout и памет

---

## Стъпка 7: Добавяне на S3 тригер

1. Добавете тригер към функцията
2. Изберете `image-upload-bucket`
3. Задайте събитие тип `All object create events`
4. Запазете тригера

---

## Стъпка 8: Тестване на системата

1. Качете изображение в `image-upload-bucket`
2. Проверете логовете в CloudWatch
3. Проверете обработеното изображение в `image-processed-bucket`
4. Проверете метаданните в DynamoDB

---

## Въпроси?

![Въпроси](https://i.imgur.com/1XZtVnL.png)
